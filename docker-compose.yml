version: '3.8'

services:
  # ============================================
  # PHP-FPM Application
  # ============================================
  app:
    build:
      context: ./backend
      dockerfile: ../docker/Dockerfile
    container_name: travel-system-app
    restart: unless-stopped
    volumes:
      - ./backend:/var/www/html
      - storage_data:/var/www/html/storage
      - cache_data:/var/www/html/bootstrap/cache
    environment:
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-1012@lg}
      - APP_ENV=${APP_ENV:-local}
      - LOG_CHANNEL=stderr
      - QUEUE_CONNECTION=rabbitmq
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASS:-guest}
      - RABBITMQ_VHOST=/
      - RABBITMQ_QUEUE=default
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - travel-network
    healthcheck:
      test: ["CMD", "php", "-r", "if (!file_exists('/var/www/html/vendor/autoload.php')) exit(1); if (!file_exists('/var/www/html/bootstrap/app.php')) exit(1); exit(0);"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # Nginx Web Server
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: travel-system-nginx
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ./backend:/var/www/html:ro
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - nginx_cache:/var/cache/nginx
      - nginx_logs:/var/log/nginx
    depends_on:
      app:
        condition: service_healthy
    networks:
      - travel-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "-O", "-", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # MySQL Database
  # ============================================
  db:
    image: mysql:8.0
    container_name: travel-system-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_PASSWORD:-1012@lg}
      MYSQL_DATABASE: travel_system
      MYSQL_USER: ${MYSQL_USER:-travel_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-1012@lg}
    ports:
      - "3307:3306"  # Porta 3307 para não conflitar com MySQL local na 3306
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/my.cnf:/etc/mysql/conf.d/custom.cnf:ro
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    networks:
      - travel-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_PASSWORD:-1012@lg}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # Redis Cache & Queue
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: travel-system-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
      - ./docker/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf --protected-mode no
    networks:
      - travel-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # Redis Commander - Interface Web para Redis (Alternativa mais leve)
  # ============================================
  rediscommander:
    image: rediscommander/redis-commander:latest
    container_name: travel-system-rediscommander
    restart: unless-stopped
    ports:
      - "8081:8081"
    environment:
      - REDIS_HOSTS=local:redis:6379
      - HTTP_USER=admin
      - HTTP_PASSWORD=
    networks:
      - travel-network
    depends_on:
      redis:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # RabbitMQ Message Broker
  # ============================================
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: travel-system-rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS:-guest}
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - travel-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # Queue Worker
  # ============================================
  php-worker:
    build:
      context: ./backend
      dockerfile: ../docker/Dockerfile
    container_name: travel-system-worker
    restart: unless-stopped
    command: >
      sh -c "
      echo '⏳ Aguardando app terminar setup...' &&
      sleep 15 &&
      php artisan queue:work rabbitmq --sleep=3 --tries=3 --max-time=3600
      "
    volumes:
      - ./backend:/var/www/html
      - storage_data:/var/www/html/storage
      - cache_data:/var/www/html/bootstrap/cache
    environment:
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-1012@lg}
      - APP_ENV=${APP_ENV:-local}
      - LOG_CHANNEL=stderr
      - SKIP_MIGRATIONS=true
      - QUEUE_CONNECTION=rabbitmq
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASS:-guest}
      - RABBITMQ_VHOST=/
      - RABBITMQ_QUEUE=default
    depends_on:
      app:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - travel-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # Laravel Scheduler
  # ============================================
  scheduler:
    build:
      context: ./backend
      dockerfile: ../docker/Dockerfile
    container_name: travel-system-scheduler
    restart: unless-stopped
    command: php artisan schedule:work
    volumes:
      - ./backend:/var/www/html
      - storage_data:/var/www/html/storage
      - cache_data:/var/www/html/bootstrap/cache
    environment:
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-1012@lg}
      - APP_ENV=${APP_ENV:-local}
      - LOG_CHANNEL=stderr
      - SKIP_MIGRATIONS=true
      - QUEUE_CONNECTION=rabbitmq
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASS:-guest}
      - RABBITMQ_VHOST=/
      - RABBITMQ_QUEUE=default
    depends_on:
      app:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - travel-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # Mailpit (Email Testing)
  # ============================================
  mailpit:
    image: axllent/mailpit
    container_name: travel-system-mailpit
    restart: unless-stopped
    ports:
      - "1025:1025"
      - "8025:8025"
    networks:
      - travel-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8025"]
      interval: 30s
      timeout: 5s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # PHPUnit Test Container
  # ============================================
  phpunit:
    build:
      context: ./backend
      dockerfile: ../docker/Dockerfile.test
    container_name: travel-system-phpunit
    volumes:
      - ./backend:/var/www/html
      - storage_data:/var/www/html/storage
      - cache_data:/var/www/html/bootstrap/cache
    environment:
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-1012@lg}
      - APP_ENV=testing
      - DB_CONNECTION=mysql
      - DB_HOST=db
      - DB_PORT=3306
      - DB_DATABASE=travel_system_test
      - DB_USERNAME=root
      - DB_PASSWORD=${MYSQL_PASSWORD:-1012@lg}
      - CACHE_DRIVER=array
      - QUEUE_CONNECTION=sync
      - LOG_CHANNEL=stderr
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - travel-network
    command: ["vendor/bin/phpunit", "--colors=always"]
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ============================================
# Volumes
# ============================================
volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
  rabbitmq_data:
    driver: local
  storage_data:
    driver: local
  cache_data:
    driver: local
  nginx_cache:
    driver: local
  nginx_logs:
    driver: local

# ============================================
# Networks
# ============================================
networks:
  travel-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
